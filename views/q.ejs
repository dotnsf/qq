<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8"/>
<title>QQ</title>
<script type="text/javascript" src="//code.jquery.com/jquery-2.2.4.min.js"></script>
<link href="//maxcdn.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" rel="stylesheet"/>
<script src="//maxcdn.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script>

<script src="/common.js"></script>
<link href="/common.css" rel="stylesheet"/>

<meta name="viewport" content="width=device-width,initial-scale=1"/>

<link rel="shortcut icon" href="/icon.png" type="image/png"/>
<link rel="icon" href="/icon.png" type="image/png"/>
<link rel="apple-touch-icon" href="/icon.png"/>

<meta name="viewport" content="width=device-width,initial-scale=1"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black"/>
<meta name="apple-mobile-web-app-title" content="QQ"/>

<style type="text/css">
.display_none{
  display: none;
}
</style>
</head>
<body>

<nav class="navbar fixed-top">
  <div class="navbar-header">
  </div>
  <div id="my-navbar">
  </div>
</nav>

<div class="container">
  <table class="" id="question_list">
    <thead>
      <tr>
        <th>#</th><th>label</th><th>updated</th>
      </tr>
    </thead>
    <tbody id="question_list_tbody">
    </tbody>
  </table>
</div>

<div class="container p-3" id="question_body">
  <table class="table table-bordered">
    <tbody id="question_body_tbody">
      <tr id="tr_id"><td>ID</td><td><input type="text" id="question_body_id" value="" class="form-control" readonly/></td><td></td></tr>
      <tr id="tr_label"><td>ラベル</td><td><input type="text" id="question_body_label" value="" class="form-control"/></td><td><button class="btn btn-warning" onClick="add_next_question();">+ Q</button></td></tr>
    </tbody>
  </table>
  <button class="btn btn-success" onClick="save_question();">Save</button>
</div>

<script>
var uuid = generateUUID();

var question_index = -1;

$(function(){
  init();
  add_next_question();

  if( uuid ){ //. #50
    $.ajax({
      type: 'GET',
      url: '/api/questions/' + uuid,
      success: function( result ){
        console.log( result );
      },
      error: function( e0, e1, e2 ){
        console.log( e0, e1, e2 );
      }
    });
  }
});

function init(){
}

function resized(){
  var browserWidth = window.innerWidth;
  var browserHeight = window.innerHeight;

}

function add_next_question(){
  question_index ++;

  var tr = '<tr id="tr_question_' + question_index + '"><td>質問 ' + question_index + '</td>'
    + '<td><textarea id="question_text_' + question_index + '" class="form-control"></textarea></td>'
    + '<td>'
    + '<table class="table">'
    + '<tr><td>回答タイプ</td><td>'
    + '<select id="question_' + question_index + '_type" idx="' + question_index + '" class="question_type"><option value="number">数字</option><option value="text">テキスト</option></select>'
    + '</td></tr>'
    + '<tr id="question_' + question_index + '_tr_default"><td>デフォルト値</td><td>'
    + '<input type="text" id="question_' + question_index + '_default" value=""/>'
    + '</td></tr>'
    + '<tr id="question_' + question_index + '_tr_min"><td>最小値</td><td>'
    + '<input type="text" id="question_' + question_index + '_min" value=""/>'
    + '</td></tr>'
    + '<tr id="question_' + question_index + '_tr_max"><td>最大値</td><td>'
    + '<input type="text" id="question_' + question_index + '_max" value=""/>'
    + '</td></tr>'
    + '</table>'
    + '</td></tr>';
  $('#question_body_tbody').append( tr );

  //$('#question_' + question_index + '_type').change( function(){
  $('.question_type').change( function(){
    var q_idx = $(this).attr('idx');
    console.log( 'q_idx = ' + q_idx );
    var question_type = $(this).val();
    switch( question_type ){
    case 'text':
      $('#question_' + q_idx + '_tr_min').addClass( 'display_none', 'none' );
      $('#question_' + q_idx + '_tr_max').addClass( 'display_none', 'none' );
      break;
    case 'number':
      $('#question_' + q_idx + '_tr_min').removeClass( 'display_none', 'none' );
      $('#question_' + q_idx + '_tr_max').removeClass( 'display_none', 'none' );
      break;
    }
  });
}

function save_question(){
  var label = $('#question_body_label').val();
  var data = {
    user_id: uuid,
    label: label,
    questions: []
  };
  for( var i = 0; i <= question_index; i ++ ){
    var question_text = $('#question_text_' + i ).val(); 
    var question_type = $('#question_' + i + '_type' ).val(); 
    var question_default = $('#question_' + i + '_default' ).val(); 
    var question_min = $('#question_' + i + '_min' ).val(); 
    var question_max = $('#question_' + i + '_max' ).val(); 
    var question = {
      text: question_text,
      type: question_type,
      default: question_default,
      min: question_min,
      max: question_max
    };
    data.questions.push( question );
  }
  console.log( 'data', data );
  $.ajax({
    url: '/api/question',
    type: 'POST',
    data: data,
    success: function( result ){
      console.log( { result } );
    },
    error: function( e0, e1, e2 ){
      console.log( e0, e1, e2 );
    }
  });
}
</script>
</body>
</html>
